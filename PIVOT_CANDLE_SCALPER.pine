// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © PivotCandleScalper 2025

//@version=5
strategy("PivotCandleScalper", overlay=true, margin_long=100, margin_short=100, default_qty_type=strategy.percent_of_equity, default_qty_value=1)

// ═══════════════════════════════════════════════════════════════
// INPUT PARAMETERS
// ═══════════════════════════════════════════════════════════════
lotSize = input.float(0.01, "Lot Size", minval=0.01, step=0.01, group="Position Sizing")
riskPercent = input.float(0.5, "Risk Percent per Trade (%)", minval=0, maxval=100, step=0.1, group="Position Sizing", tooltip="Set to 0 to use fixed lot size")
stopLossPips = input.float(15, "Stop Loss (Pips)", minval=1, step=1, group="Risk Management")
takeProfit1Pips = input.float(20, "Take Profit 1 (Pips)", minval=1, step=1, group="Risk Management")
takeProfit2Pips = input.float(40, "Take Profit 2 (Pips)", minval=1, step=1, group="Risk Management")
maxTradesPerDay = input.int(10, "Max Trades Per Day", minval=0, step=1, group="Risk Management", tooltip="0 = unlimited")
maxSpread = input.float(30, "Max Spread (Points)", minval=0, step=1, group="Risk Management")
enableTradingHours = input.bool(false, "Enable Trading Hours", group="Trading Hours")
tradeStartHour = input.int(0, "Trade Start Hour (0-23)", minval=0, maxval=23, group="Trading Hours")
tradeEndHour = input.int(23, "Trade End Hour (0-23)", minval=0, maxval=23, group="Trading Hours")

// ═══════════════════════════════════════════════════════════════
// PIVOT POINT CALCULATIONS
// ═══════════════════════════════════════════════════════════════
// Get previous day's high, low, close for pivot calculation
prevDayHigh = request.security(syminfo.tickerid, "D", high[1], barmerge.gaps_off, barmerge.lookahead_on)
prevDayLow = request.security(syminfo.tickerid, "D", low[1], barmerge.gaps_off, barmerge.lookahead_on)
prevDayClose = request.security(syminfo.tickerid, "D", close[1], barmerge.gaps_off, barmerge.lookahead_on)

// Calculate pivot points
PP = (prevDayHigh + prevDayLow + prevDayClose) / 3
R1 = 2 * PP - prevDayLow
R2 = PP + (prevDayHigh - prevDayLow)
S1 = 2 * PP - prevDayHigh
S2 = PP - (prevDayHigh - prevDayLow)

// Plot pivot levels
plot(PP, "Pivot Point", color=color.yellow, linewidth=2, style=plot.style_line)
plot(R1, "Resistance 1", color=color.red, linewidth=1, style=plot.style_line)
plot(R2, "Resistance 2", color=color.new(color.red, 50), linewidth=1, style=plot.style_line)
plot(S1, "Support 1", color=color.green, linewidth=1, style=plot.style_line)
plot(S2, "Support 2", color=color.new(color.green, 50), linewidth=1, style=plot.style_line)

// ═══════════════════════════════════════════════════════════════
// SYMBOL-SPECIFIC PIP CALCULATIONS
// ═══════════════════════════════════════════════════════════════
// Calculate pip value based on symbol type
pipValue = syminfo.type == "forex" ? (syminfo.mintick * 10) : syminfo.mintick

// ═══════════════════════════════════════════════════════════════
// CANDLESTICK PATTERN DETECTION FUNCTIONS
// ═══════════════════════════════════════════════════════════════
// Bullish Pin Bar: Long lower wick >= 2x body, small upper wick <= 30% of range
isBullishPinBar(o, h, l, c) => body = math.abs(c - o), totalRange = h - l, lowerWick = math.min(o, c) - l, upperWick = h - math.max(o, c), totalRange > 0 and lowerWick >= (2 * body) and upperWick <= (0.3 * totalRange)

// Bearish Pin Bar: Long upper wick >= 2x body, small lower wick <= 30% of range
isBearishPinBar(o, h, l, c) => body = math.abs(c - o), totalRange = h - l, lowerWick = math.min(o, c) - l, upperWick = h - math.max(o, c), totalRange > 0 and upperWick >= (2 * body) and lowerWick <= (0.3 * totalRange)

// Bullish Engulfing: Current bullish candle engulfs previous bearish candle's body
isBullishEngulfing() => close[1] > open[1] and close[2] < open[2] and open[1] < close[2] and close[1] > open[2]

// Bearish Engulfing: Current bearish candle engulfs previous bullish candle's body
isBearishEngulfing() => close[1] < open[1] and close[2] > open[2] and open[1] > close[2] and close[1] < open[2]

// ═══════════════════════════════════════════════════════════════
// TRADING HOURS CHECK
// ═══════════════════════════════════════════════════════════════
isTradingHourAllowed() => not enableTradingHours or (tradeStartHour <= tradeEndHour ? (hour >= tradeStartHour and hour <= tradeEndHour) : (hour >= tradeStartHour or hour <= tradeEndHour))

// ═══════════════════════════════════════════════════════════════
// MARKET BIAS DETERMINATION
// ═══════════════════════════════════════════════════════════════
bullishBias = close > PP
bearishBias = close < PP

// ═══════════════════════════════════════════════════════════════
// PRICE LEVEL DETECTION (Near S1, PP, or R1)
// ═══════════════════════════════════════════════════════════════
tolerance = 5 * pipValue
nearS1 = math.abs(close - S1) <= tolerance
nearPP = math.abs(close - PP) <= tolerance
nearR1 = math.abs(close - R1) <= tolerance

// ═══════════════════════════════════════════════════════════════
// BULLISH SETUP DETECTION
// ═══════════════════════════════════════════════════════════════
bullishPinDetected = isBullishPinBar(open[1], high[1], low[1], close[1])
bullishEngulfingDetected = isBullishEngulfing()
bullishPatternConfirmed = bullishPinDetected or bullishEngulfingDetected
bullishSetup = bullishBias and (nearS1 or nearPP) and bullishPatternConfirmed

// ═══════════════════════════════════════════════════════════════
// BEARISH SETUP DETECTION
// ═══════════════════════════════════════════════════════════════
bearishPinDetected = isBearishPinBar(open[1], high[1], low[1], close[1])
bearishEngulfingDetected = isBearishEngulfing()
bearishPatternConfirmed = bearishPinDetected or bearishEngulfingDetected
bearishSetup = bearishBias and (nearR1 or nearPP) and bearishPatternConfirmed

// ═══════════════════════════════════════════════════════════════
// SPREAD FILTERING
// ═══════════════════════════════════════════════════════════════
// Note: TradingView doesn't provide real-time spread data
// This is a simplified check - actual spread would need broker data
spreadOK = true  // Assume spread is OK for backtesting purposes

// ═══════════════════════════════════════════════════════════════
// DAILY TRADE LIMIT TRACKING
// ═══════════════════════════════════════════════════════════════
var int tradesCountToday = 0
var int lastTradeDay = 0

// Reset counter on new day
if (dayofmonth != lastTradeDay)
    tradesCountToday := 0
    lastTradeDay := dayofmonth

// Check if daily limit reached
dailyLimitOK = maxTradesPerDay <= 0 or tradesCountToday < maxTradesPerDay

// ═══════════════════════════════════════════════════════════════
// ENTRY SIGNALS
// ═══════════════════════════════════════════════════════════════
longSignal = bullishSetup and isTradingHourAllowed() and spreadOK and dailyLimitOK and barstate.isconfirmed
shortSignal = bearishSetup and isTradingHourAllowed() and spreadOK and dailyLimitOK and barstate.isconfirmed

// Increment counter when signal fires
if (longSignal or shortSignal)
    tradesCountToday := tradesCountToday + 1

// ═══════════════════════════════════════════════════════════════
// STOP LOSS AND TAKE PROFIT CALCULATIONS
// ═══════════════════════════════════════════════════════════════
// For long trades: SL below signal candle low
longStopLoss = low[1] - (2 * pipValue)
longTP1 = close + (takeProfit1Pips * pipValue)
longTP2 = close + (takeProfit2Pips * pipValue)

// For short trades: SL above signal candle high
shortStopLoss = high[1] + (2 * pipValue)
shortTP1 = close - (takeProfit1Pips * pipValue)
shortTP2 = close - (takeProfit2Pips * pipValue)

// ═══════════════════════════════════════════════════════════════
// POSITION SIZING
// ═══════════════════════════════════════════════════════════════
// Calculate position size based on risk percent
// In TradingView, we use percentage of equity
positionSizePercent = riskPercent > 0 ? riskPercent : 1.0

// ═══════════════════════════════════════════════════════════════
// STRATEGY EXECUTION
// ═══════════════════════════════════════════════════════════════
// Long Entry - Split into two positions (50% each for TP1 and TP2)
if (longSignal)
    // First 50% position with TP1
    strategy.entry("Long_TP1", strategy.long, qty=50, comment="Buy TP1")
    strategy.exit("Exit_Long_TP1", "Long_TP1", stop=longStopLoss, limit=longTP1)
    
    // Second 50% position with TP2
    strategy.entry("Long_TP2", strategy.long, qty=50, comment="Buy TP2")
    strategy.exit("Exit_Long_TP2", "Long_TP2", stop=longStopLoss, limit=longTP2)

// Short Entry - Split into two positions (50% each for TP1 and TP2)
if (shortSignal)
    // First 50% position with TP1
    strategy.entry("Short_TP1", strategy.short, qty=50, comment="Sell TP1")
    strategy.exit("Exit_Short_TP1", "Short_TP1", stop=shortStopLoss, limit=shortTP1)
    
    // Second 50% position with TP2
    strategy.entry("Short_TP2", strategy.short, qty=50, comment="Sell TP2")
    strategy.exit("Exit_Short_TP2", "Short_TP2", stop=shortStopLoss, limit=shortTP2)

// ═══════════════════════════════════════════════════════════════
// VISUAL SIGNALS ON CHART
// ═══════════════════════════════════════════════════════════════
// Plot buy signals
plotshape(longSignal, "Buy Signal", shape.triangleup, location.belowbar, color.green, size=size.small)

// Plot sell signals
plotshape(shortSignal, "Sell Signal", shape.triangledown, location.abovebar, color.red, size=size.small)

// Plot bullish pin bars
plotshape(bullishPinDetected, "Bullish Pin", shape.diamond, location.belowbar, color.new(color.green, 50), size=size.tiny)

// Plot bearish pin bars
plotshape(bearishPinDetected, "Bearish Pin", shape.diamond, location.abovebar, color.new(color.red, 50), size=size.tiny)

// Plot bullish engulfing
plotshape(bullishEngulfingDetected, "Bullish Engulf", shape.circle, location.belowbar, color.new(color.blue, 50), size=size.tiny)

// Plot bearish engulfing
plotshape(bearishEngulfingDetected, "Bearish Engulf", shape.circle, location.abovebar, color.new(color.orange, 50), size=size.tiny)

// Plot Stop Loss and Take Profit levels for visual reference
plot(longSignal ? longStopLoss : na, "Long SL", color=color.red, style=plot.style_cross, linewidth=2)
plot(longSignal ? longTP1 : na, "Long TP1", color=color.green, style=plot.style_cross, linewidth=1)
plot(longSignal ? longTP2 : na, "Long TP2", color=color.blue, style=plot.style_cross, linewidth=1)
plot(shortSignal ? shortStopLoss : na, "Short SL", color=color.red, style=plot.style_cross, linewidth=2)
plot(shortSignal ? shortTP1 : na, "Short TP1", color=color.green, style=plot.style_cross, linewidth=1)
plot(shortSignal ? shortTP2 : na, "Short TP2", color=color.blue, style=plot.style_cross, linewidth=1)

// ═══════════════════════════════════════════════════════════════
// BACKGROUND COLORING FOR MARKET BIAS
// ═══════════════════════════════════════════════════════════════
bgcolor(bullishBias ? color.new(color.green, 95) : bearishBias ? color.new(color.red, 95) : na, title="Market Bias")

// ═══════════════════════════════════════════════════════════════
// ALERT CONDITIONS
// ═══════════════════════════════════════════════════════════════
alertcondition(longSignal, title="Long Signal Alert", message="PivotCandleScalper: BUY signal detected!")
alertcondition(shortSignal, title="Short Signal Alert", message="PivotCandleScalper: SELL signal detected!")

// ═══════════════════════════════════════════════════════════════
// INFORMATION TABLE (displays current pivot levels and trade count)
// ═══════════════════════════════════════════════════════════════
var table infoTable = table.new(position.top_right, 2, 7, border_width=1)
if barstate.islast
    table.cell(infoTable, 0, 0, "Level", bgcolor=color.gray, text_color=color.white)
    table.cell(infoTable, 1, 0, "Price", bgcolor=color.gray, text_color=color.white)
    table.cell(infoTable, 0, 1, "R2", bgcolor=color.new(color.red, 80))
    table.cell(infoTable, 1, 1, str.tostring(R2, format.mintick), bgcolor=color.new(color.red, 80))
    table.cell(infoTable, 0, 2, "R1", bgcolor=color.new(color.red, 60))
    table.cell(infoTable, 1, 2, str.tostring(R1, format.mintick), bgcolor=color.new(color.red, 60))
    table.cell(infoTable, 0, 3, "PP", bgcolor=color.yellow, text_color=color.black)
    table.cell(infoTable, 1, 3, str.tostring(PP, format.mintick), bgcolor=color.yellow, text_color=color.black)
    table.cell(infoTable, 0, 4, "S1", bgcolor=color.new(color.green, 60))
    table.cell(infoTable, 1, 4, str.tostring(S1, format.mintick), bgcolor=color.new(color.green, 60))
    table.cell(infoTable, 0, 5, "S2", bgcolor=color.new(color.green, 80))
    table.cell(infoTable, 1, 5, str.tostring(S2, format.mintick), bgcolor=color.new(color.green, 80))
    table.cell(infoTable, 0, 6, "Trades Today", bgcolor=color.blue)
    table.cell(infoTable, 1, 6, str.tostring(tradesCountToday) + "/" + str.tostring(maxTradesPerDay > 0 ? maxTradesPerDay : "∞"), bgcolor=color.blue)
